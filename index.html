<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная 3D Карта на Mapbox</title>
    <!-- Используем актуальную версию библиотеки Mapbox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <!-- Подключение Turf.js для расчетов на карте -->
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            /* Задаем фон в цвет вашего сайта */
            background-color: #15161a;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        /* Стиль для всплывающих окон */
        .mapboxgl-popup-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 15px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            font-size: 14px;
            color: #333;
        }
        .mapboxgl-popup-close-button {
            color: #555;
        }
        /* Стили для кнопки в плашке */
        .popup-button {
            display: block;
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #007cbf;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 5px;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        .popup-button:hover {
            background-color: #005a8c;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWljaGFpbHVrc2l0ZTEiLCJhIjoiY21nMHR6c3JuMGhzNzJrczlheXRkdnRlbSJ9.fCpm3yrZdD52g3O72a-ylQ';

    const europeanCities = [
        { name: 'Paris', coords: [2.3522, 48.8566] }, { name: 'London', coords: [-0.1278, 51.5074] },
        { name: 'Madrid', coords: [-3.7038, 40.4168] }, { name: 'Berlin', coords: [13.4050, 52.5200] },
        { name: 'Rome', coords: [12.4964, 41.9028] }, { name: 'Kyiv', coords: [30.5234, 50.4501] },
        { name: 'Warsaw', coords: [21.0122, 52.2297] }, { name: 'Bucharest', coords: [26.1025, 44.4268] },
        { name: 'Vienna', coords: [16.3738, 48.2082] }, { name: 'Budapest', coords: [19.0402, 47.4979] },
        { name: 'Prague', coords: [14.4378, 50.0755] }, { name: 'Sofia', coords: [23.3219, 42.6977] },
        { name: 'Brussels', coords: [4.3517, 50.8503] }, { name: 'Amsterdam', coords: [4.8952, 52.3702] },
        { name: 'Stockholm', coords: [18.0686, 59.3293] }, { name: 'Oslo', coords: [10.7522, 59.9139] },
        { name: 'Copenhagen', coords: [12.5683, 55.6761] }, { name: 'Helsinki', coords: [24.9384, 60.1699] },
        { name: 'Dublin', coords: [-6.2603, 53.3498] }, { name: 'Lisbon', coords: [-9.1393, 38.7223] },
        { name: 'Athens', coords: [23.7275, 37.9838] }, { name: 'Bratislava', coords: [17.1077, 48.1486] },
        { name: 'Ljubljana', coords: [14.5058, 46.0569] }, { name: 'Zagreb', coords: [15.9819, 45.8150] },
        { name: 'Tirana', coords: [19.8187, 41.3275] }, { name: 'Sarajevo', coords: [18.4131, 43.8563] },
        { name: 'Skopje', coords: [21.4254, 41.9981] }, { name: 'Podgorica', coords: [19.2594, 42.4304] },
        { name: 'Valletta', coords: [14.5146, 35.8989] }, { name: 'Luxembourg', coords: [6.1296, 49.6116] },
        { name: 'Monaco', coords: [7.4246, 43.7384] }, { name: 'Andorra la Vella', coords: [1.5218, 42.5063] },
        { name: 'Vaduz', coords: [9.5209, 47.1410] }, { name: 'Bern', coords: [7.4474, 46.9480] },
        { name: 'Istanbul', coords: [28.9784, 41.0082] }
    ];

    const destinationClinics = {
        'Клиника на Молодіжній': {
            coords: [26.952723, 49.411302], isDestination: true,
            url: 'https://www.google.com/maps/place/Стоматологическая+кликика+Вита+Дент/@49.4113025,26.952724,15z/data=!4m2!3m1!1s0x0:0x6c0e8a719c676993'
        },
        'Клиника на Шевченка': {
            coords: [27.016370, 49.416488], isDestination: true,
            url: 'https://www.google.com/maps/place/Віта+Дент+Стоматологічна+клініка/@49.4164889,27.0163709,15z/data=!4m2!3m1!1s0x0:0x87d605151522f790'
        }
    };
    
    const MAX_CONCURRENT_ANIMATIONS = 11;
    let activeAnimations = [];
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        projection: 'globe',
        center: [15, 49],
        zoom: 3.5,
        antialias: true
    });

    map.on('error', (e) => console.error('ОШИБКА MAPBOX:', e.error));

    map.on('load', () => {
        console.log('Карта успешно загружена!');
        
        map.setFog({
            'color': '#15161a', 'high-color': '#15161a',
            'horizon-blend': 0.02, 'space-color': '#15161a',
            'star-intensity': 0.2
        });

        const layers = map.getStyle().layers;
        for (const layer of layers) {
            if (layer.type === 'symbol' && layer.layout['text-field']) {
                if (layer['source-layer'] && (layer['source-layer'].includes('place') || layer['source-layer'].includes('settlement'))) {
                     map.setFilter(layer.id, ['all', 
                        ['!=', ['get', 'iso_3166_1_alpha_2'], 'RU'],
                        ['!=', ['get', 'iso_3166_1_alpha_2'], 'BY']
                     ]);
                }
            }
        }

        const clinicPoints = Object.entries(destinationClinics).map(([name, data]) => turf.point(data.coords, { name, isDestination: true }));
        
        map.addSource('clinic-points', { 'type': 'geojson', 'data': turf.featureCollection(clinicPoints) });
        map.addSource('start-points', { 'type': 'geojson', 'data': turf.featureCollection([]) });
        map.addSource('routes', { 'type': 'geojson', 'data': turf.featureCollection([]) });
        map.addSource('animation-points', { 'type': 'geojson', 'data': turf.featureCollection([]) });
        
        map.addLayer({
            'id': 'clinic-points-layer', 'type': 'circle', 'source': 'clinic-points',
            'paint': { 'circle-radius': 6, 'circle-color': '#ff4136', 'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff' }
        });
        
        map.addLayer({
            'id': 'start-points-layer', 'type': 'circle', 'source': 'start-points',
            'paint': {
                'circle-radius': 4, 'circle-color': '#007cbf',
                'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff',
                'circle-opacity': ['get', 'opacity']
            }
        });

        map.addLayer({
            'id': 'routes-layer', 'type': 'line', 'source': 'routes',
            'paint': {
                'line-color': '#007cbf', 'line-width': 1.5,
                'line-opacity': ['get', 'opacity'],
                'line-dasharray': [2, 2]
            }
        });
        
        map.addLayer({
            'id': 'animation-layer', 'type': 'circle', 'source': 'animation-points',
            'paint': {
                'circle-radius': 5, 'circle-color': 'white',
                'circle-opacity': ['get', 'opacity']
            }
        });

        function createNewAnimation() {
            const startCity = europeanCities[Math.floor(Math.random() * europeanCities.length)];
            const endClinic = Object.values(destinationClinics)[Math.floor(Math.random() * 2)];
            
            let route;
            const needsNorthernDetour = ['Stockholm', 'Oslo', 'Copenhagen', 'Helsinki'].includes(startCity.name);
            const needsSouthernDetour = ['Istanbul', 'Athens'].includes(startCity.name);
            
            if (needsNorthernDetour) {
                const waypoint = turf.point([21.0122, 52.2297]); 
                const part1 = turf.greatCircle(startCity.coords, waypoint.geometry.coordinates, { npoints: 100 });
                const part2 = turf.greatCircle(waypoint.geometry.coordinates, endClinic.coords, { npoints: 100 });
                route = turf.lineString([...part1.geometry.coordinates, ...part2.geometry.coordinates]);
            } else if (needsSouthernDetour) {
                const waypoint = turf.point([26.1025, 44.4268]); 
                const part1 = turf.greatCircle(startCity.coords, waypoint.geometry.coordinates, { npoints: 100 });
                const part2 = turf.greatCircle(waypoint.geometry.coordinates, endClinic.coords, { npoints: 100 });
                route = turf.lineString([...part1.geometry.coordinates, ...part2.geometry.coordinates]);
            } else {
                route = turf.greatCircle(startCity.coords, endClinic.coords, { npoints: 200 });
            }

            const speed = 0.0008 + Math.random() * 0.0005;

            return {
                route: route,
                startPoint: turf.point(startCity.coords, { name: startCity.name }),
                progress: 0,
                speed: speed
            };
        }

        for (let i = 0; i < MAX_CONCURRENT_ANIMATIONS; i++) {
            activeAnimations.push(createNewAnimation());
        }

        map.on('click', 'clinic-points-layer', (e) => {
            const feature = e.features[0];
            const cityName = feature.properties.name;
            const cityData = destinationClinics[cityName];
            if (cityData && cityData.url) {
                const popupContent = `<strong>${cityName}</strong><a href="${cityData.url}" target="_blank" class="popup-button">Смотреть на Google Maps</a>`;
                new mapboxgl.Popup().setLngLat(feature.geometry.coordinates).setHTML(popupContent).addTo(map);
            }
        });
        map.on('mouseenter', 'clinic-points-layer', (e) => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'clinic-points-layer', () => { map.getCanvas().style.cursor = ''; });

        function animate() {
            for (let i = 0; i < activeAnimations.length; i++) {
                const anim = activeAnimations[i];
                anim.progress += anim.speed;
                if (anim.progress >= 1) {
                    activeAnimations[i] = createNewAnimation();
                }
            }

            const currentRoutes = [];
            const currentStartPoints = [];
            const currentAnimationPoints = [];

            activeAnimations.forEach(anim => {
                const progress = Math.min(anim.progress, 1);
                
                // --- ИЗМЕНЕНИЕ: Исправлена логика исчезновения ---
                const FADE_IN_TIME = 0.10;  // 10% на появление
                const FADE_OUT_TIME = 0.02; // 2% на исчезновение
                let opacity = 0.7; 
                if (progress < FADE_IN_TIME) {
                    opacity = (progress / FADE_IN_TIME) * 0.7;
                } else if (progress > 1 - FADE_OUT_TIME) {
                    opacity = ((1 - progress) / FADE_OUT_TIME) * 0.7;
                }

                anim.route.properties = { opacity };
                anim.startPoint.properties.opacity = opacity;
                currentRoutes.push(anim.route);
                currentStartPoints.push(anim.startPoint);

                const routeDistance = turf.length(anim.route);
                const currentPoint = turf.along(anim.route, routeDistance * progress);
                currentPoint.properties = { opacity };
                currentAnimationPoints.push(currentPoint);
            });

            map.getSource('routes').setData(turf.featureCollection(currentRoutes));
            map.getSource('start-points').setData(turf.featureCollection(currentStartPoints));
            map.getSource('animation-points').setData(turf.featureCollection(currentAnimationPoints));
            
            requestAnimationFrame(animate);
        }
        animate();
    });
</script>
</body>
</html>

