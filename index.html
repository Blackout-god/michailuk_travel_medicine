<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная 3D Карта на Mapbox</title>
    <!-- Используем актуальную версию библиотеки Mapbox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <!-- Подключение Turf.js для расчетов на карте -->
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            /* Задаем фон в цвет вашего сайта */
            background-color: #15161a;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        /* Стиль для всплывающих окон */
        .mapboxgl-popup-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 15px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            font-size: 14px;
            color: #333;
        }
        .mapboxgl-popup-close-button {
            color: #555;
        }
        /* Стили для кнопки в плашке */
        .popup-button {
            display: block;
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #007cbf;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 5px;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        .popup-button:hover {
            background-color: #005a8c;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWljaGFpbHVrc2l0ZTEiLCJhIjoiY21nMHR6c3JuMGhzNzJrczlheXRkdnRlbSJ9.fCpm3yrZdD52g3O72a-ylQ';

    const worldCities = [
        { name: 'Tokyo', coords: [139.6917, 35.6895] }, { name: 'Jakarta', coords: [106.8650, -6.1751] },
        { name: 'Delhi', coords: [77.1025, 28.7041] }, { name: 'Manila', coords: [120.9842, 14.5995] },
        { name: 'São Paulo', coords: [-46.6333, -23.5505] }, { name: 'Seoul', coords: [126.9780, 37.5665] },
        { name: 'Mumbai', coords: [72.8777, 19.0760] }, { name: 'Shanghai', coords: [121.4737, 31.2304] },
        { name: 'Mexico City', coords: [-99.1332, 19.4326] }, { name: 'Guangzhou', coords: [113.2644, 23.1291] },
        { name: 'Cairo', coords: [31.2357, 30.0444] }, { name: 'Beijing', coords: [116.4074, 39.9042] },
        { name: 'New York', coords: [-74.0060, 40.7128] }, { name: 'Kolkata', coords: [88.3639, 22.5726] },
        { name: 'Buenos Aires', coords: [-58.3816, -34.6037] }, { name: 'Istanbul', coords: [28.9784, 41.0082] },
        { name: 'Lagos', coords: [3.3792, 6.5244] }, { name: 'Rio de Janeiro', coords: [-43.1729, -22.9068] },
        { name: 'Los Angeles', coords: [-118.2437, 34.0522] }, { name: 'Paris', coords: [2.3522, 48.8566] },
        { name: 'London', coords: [-0.1278, 51.5074] }, { name: 'Lima', coords: [-77.0428, -12.0464] },
        { name: 'Bogotá', coords: [-74.0721, 4.7110] }, { name: 'Ho Chi Minh City', coords: [106.6297, 10.8231] },
        { name: 'Bangkok', coords: [100.5018, 13.7563] }, { name: 'Tehran', coords: [51.3890, 35.6892] },
        { name: 'Santiago', coords: [-70.6693, -33.4489] }, { name: 'Madrid', coords: [-3.7038, 40.4168] },
        { name: 'Toronto', coords: [-79.3832, 43.6532] }, { name: 'Sydney', coords: [151.2093, -33.8688] },
        { name: 'Berlin', coords: [13.4050, 52.5200] }, { name: 'Rome', coords: [12.4964, 41.9028] },
        { name: 'Cape Town', coords: [18.4241, -33.9249] }, { name: 'Warsaw', coords: [21.0122, 52.2297] },
        { name: 'Dubai', coords: [55.2708, 25.2048] }, { name: 'Singapore', coords: [103.8198, 1.3521] },
        { name: 'Chicago', coords: [-87.6298, 41.8781] }, { name: 'Houston', coords: [-95.3698, 29.7604] },
        { name: 'Phoenix', coords: [-112.0740, 33.4484] }, { name: 'Philadelphia', coords: [-75.1652, 39.9526] },
        { name: 'San Antonio', coords: [-98.4936, 29.4241] }, { name: 'San Diego', coords: [-117.1611, 32.7157] },
        { name: 'Dallas', coords: [-96.7970, 32.7767] }, { name: 'San Jose', coords: [-121.8863, 37.3382] },
        { name: 'Riyadh', coords: [46.6753, 24.7136] }, { name: 'Kyiv', coords: [30.5234, 50.4501] },
        { name: 'Melbourne', coords: [144.9631, -37.8136] }, { name: 'Alexandria', coords: [29.9187, 31.2001] }
    ];

    const destinationClinics = {
        'Клиника на Молодіжній': {
            coords: [26.952723, 49.411302], isDestination: true,
            url: 'https://www.google.com/maps/place/Стоматологическая+кликика+Вита+Дент/@49.4113025,26.952724,15z/data=!4m2!3m1!1s0x0:0x6c0e8a719c676993'
        },
        'Клиника на Шевченка': {
            coords: [27.016370, 49.416488], isDestination: true,
            url: 'https://www.google.com/maps/place/Віта+Дент+Стоматологічна+клініка/@49.4164889,27.0163709,15z/data=!4m2!3m1!1s0x0:0x87d605151522f790'
        }
    };
    
    const MAX_CONCURRENT_ANIMATIONS = 7;
    let activeAnimations = [];

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        projection: 'globe',
        center: [27, 49],
        zoom: 1.5,
        antialias: true
    });

    map.on('error', (e) => console.error('ОШИБКА MAPBOX:', e.error));

    map.on('load', () => {
        console.log('Карта успешно загружена!');
        
        map.setFog({
            'color': '#15161a', 'high-color': '#15161a',
            'horizon-blend': 0.02, 'space-color': '#15161a',
            'star-intensity': 0.2
        });

        const clinicPoints = Object.entries(destinationClinics).map(([name, data]) => turf.point(data.coords, { name, isDestination: true }));

        map.addSource('clinic-points', { 'type': 'geojson', 'data': turf.featureCollection(clinicPoints) });
        map.addSource('start-points', { 'type': 'geojson', 'data': turf.featureCollection([]) });
        map.addSource('routes', { 'type': 'geojson', 'data': turf.featureCollection([]) });
        map.addSource('animation-points', { 'type': 'geojson', 'data': turf.featureCollection([]) });
        
        map.addLayer({
            'id': 'clinic-points-layer', 'type': 'circle', 'source': 'clinic-points',
            'paint': { 'circle-radius': 6, 'circle-color': '#ff4136', 'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff' }
        });
        
        map.addLayer({
            'id': 'start-points-layer', 'type': 'circle', 'source': 'start-points',
            'paint': { 'circle-radius': 4, 'circle-color': '#007cbf', 'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff' }
        });

        map.addLayer({ 'id': 'routes-layer', 'type': 'line', 'source': 'routes', 'paint': { 'line-color': '#007cbf', 'line-width': 1.5, 'line-opacity': 0.6 }});
        map.addLayer({ 'id': 'animation-layer', 'type': 'circle', 'source': 'animation-points', 'paint': { 'circle-radius': 5, 'circle-color': '#007cbf', 'circle-stroke-width': 1, 'circle-stroke-color': '#ffffff' }});

        function createNewAnimation() {
            const startCity = worldCities[Math.floor(Math.random() * worldCities.length)];
            const endClinic = Object.values(destinationClinics)[Math.floor(Math.random() * 2)];
            const route = turf.greatCircle(startCity.coords, endClinic.coords, { npoints: 200 });
            
            // --- ИЗМЕНЕНИЕ: Каждая анимация получает свою случайную скорость ---
            const speed = 0.0015 + Math.random() * 0.001;

            return {
                route: route,
                startPoint: turf.point(startCity.coords, { name: startCity.name, isDestination: false }),
                progress: 0,
                speed: speed // Сохраняем скорость
            };
        }

        for (let i = 0; i < MAX_CONCURRENT_ANIMATIONS; i++) {
            activeAnimations.push(createNewAnimation());
        }

        map.on('click', 'clinic-points-layer', (e) => {
            const feature = e.features[0];
            const cityName = feature.properties.name;
            const cityData = destinationClinics[cityName];
            
            if (feature.properties.isDestination && cityData && cityData.url) {
                const popupContent = `<strong>${cityName}</strong><a href="${cityData.url}" target="_blank" class="popup-button">Смотреть на Google Maps</a>`;
                new mapboxgl.Popup().setLngLat(feature.geometry.coordinates).setHTML(popupContent).addTo(map);
            }
        });
        map.on('mouseenter', 'clinic-points-layer', (e) => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'clinic-points-layer', () => { map.getCanvas().style.cursor = ''; });

        function animate() {
            // --- ИЗМЕНЕНИЕ: Независимая логика для каждой линии ---
            for (let i = 0; i < activeAnimations.length; i++) {
                const anim = activeAnimations[i];
                // Используем индивидуальную скорость
                anim.progress += anim.speed; 
                
                // Если анимация завершилась, заменяем ее на новую
                if (anim.progress >= 1) {
                    activeAnimations[i] = createNewAnimation();
                }
            }

            // Обновляем источники данных для Mapbox
            const currentRoutes = activeAnimations.map(anim => anim.route);
            const currentStartPoints = activeAnimations.map(anim => anim.startPoint);
            const currentComets = activeAnimations.map(anim => {
                const routeDistance = turf.length(anim.route);
                const progress = Math.min(anim.progress, 1);
                return turf.along(anim.route, routeDistance * progress);
            });

            map.getSource('routes').setData(turf.featureCollection(currentRoutes));
            map.getSource('start-points').setData(turf.featureCollection(currentStartPoints));
            map.getSource('animation-points').setData(turf.featureCollection(currentComets));
            
            requestAnimationFrame(animate);
        }
        animate();
    });
</script>
</body>
</html>

